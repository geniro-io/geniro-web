import { DeleteOutlined, EllipsisOutlined } from '@ant-design/icons';
import {
  Avatar,
  Button,
  Dropdown,
  Popconfirm,
  Space,
  Tag,
  Typography,
} from 'antd';
import React from 'react';

import type { ThreadDto, ThreadDtoStatusEnum } from '../../../autogenerated';
import { getThreadStatusDisplay } from '../../../utils/threadStatus';
import type {
  DraftThread,
  GraphCacheEntry,
  ThreadTokenUsageSnapshot,
} from '../types';
import { ThreadTokenUsageLine } from './ThreadTokenUsageLine';

const { Text } = Typography;

interface ThreadListItemProps {
  thread: ThreadDto | DraftThread;
  isActive: boolean;
  graphCache: Record<string, GraphCacheEntry>;
  selectedAgentNodeId: string | null;
  onSelect: (threadId: string) => void;
  onSelectAgent: (nodeId: string | null) => void;
  onDeleteThread: (threadId: string) => void;
  // Agent-related data (only needed when active & not draft)
  agents: {
    nodeId: string;
    label: string;
    description?: string;
    avatarSrc?: string;
  }[];
  threadUsage?: ThreadTokenUsageSnapshot;
  usageByNode: Record<string, ThreadTokenUsageSnapshot>;
  contextPercent?: number;
  contextMaxTokens?: number;
  getNodeTemplateId: (nodeId: string) => string | undefined;
  getNodeConfigNumber: (nodeId: string, key: string) => number | undefined;
}

export const ThreadListItem: React.FC<ThreadListItemProps> = React.memo(
  ({
    thread,
    isActive,
    graphCache,
    selectedAgentNodeId,
    onSelect,
    onSelectAgent,
    onDeleteThread,
    agents,
    threadUsage,
    usageByNode,
    contextPercent,
    contextMaxTokens,
    getNodeTemplateId,
    getNodeConfigNumber,
  }) => {
    const isDraft = 'isDraft' in thread && thread.isDraft === true;
    const statusMeta = isDraft
      ? { label: 'Draft', color: '#d9d9d9' }
      : getThreadStatusDisplay(
          (thread as ThreadDto).status as ThreadDtoStatusEnum,
        );
    const graphName = graphCache[thread.graphId]?.graph.name;
    const createdAt = new Date(thread.createdAt).toLocaleString();

    return (
      <div
        onClick={() => onSelect(thread.id)}
        onMouseEnter={(e) => {
          if (!isActive) {
            e.currentTarget.style.backgroundColor = '#fafafa';
          }
        }}
        onMouseLeave={(e) => {
          if (!isActive) {
            e.currentTarget.style.backgroundColor = '#fff';
          }
        }}
        style={{
          padding: '12px 16px',
          borderBottom: '1px solid #f0f0f0',
          cursor: 'pointer',
          backgroundColor: isActive ? '#f5f9ff' : '#fff',
          overflow: 'hidden',
          transition: 'background-color 0.2s ease',
        }}>
        <Space
          direction="vertical"
          size={4}
          style={{ width: '100%', minWidth: 0 }}>
          <div
            style={{
              width: '100%',
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              minWidth: 0,
            }}>
            <div style={{ flex: 1, minWidth: 0 }}>
              <Text
                strong
                ellipsis={{
                  tooltip: thread.name || 'New Thread',
                }}
                style={{
                  width: '100%',
                  display: 'block',
                }}>
                {thread.name || 'New Thread'}
              </Text>
            </div>
            {statusMeta && (
              <Tag
                color={statusMeta.color}
                style={{ margin: 0, flexShrink: 0, whiteSpace: 'nowrap' }}>
                {statusMeta.label}
              </Tag>
            )}
            {!isDraft && (
              <Dropdown
                menu={{
                  items: [
                    {
                      key: 'delete',
                      label: (
                        <Popconfirm
                          title="Delete thread"
                          description="Are you sure you want to delete this thread?"
                          onConfirm={(e) => {
                            e?.stopPropagation();
                            onDeleteThread(thread.id);
                          }}
                          onCancel={(e) => e?.stopPropagation()}
                          okText="Delete"
                          cancelText="Cancel"
                          okButtonProps={{ danger: true }}>
                          <div
                            onClick={(e) => e.stopPropagation()}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: 8,
                            }}>
                            <DeleteOutlined />
                            Delete
                          </div>
                        </Popconfirm>
                      ),
                    },
                  ],
                }}
                trigger={['click']}
                placement="bottomRight">
                <Button
                  type="text"
                  size="small"
                  icon={<EllipsisOutlined />}
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    flexShrink: 0,
                    padding: '4px 8px',
                  }}
                />
              </Dropdown>
            )}
          </div>
          <Text
            type="secondary"
            title={graphName || 'Loading graph…'}
            style={{
              fontSize: 12,
              whiteSpace: 'nowrap',
              overflow: 'hidden',
              textOverflow: 'ellipsis',
              minWidth: 0,
            }}>
            {graphName || 'Loading graph…'}
          </Text>
          <Text type="secondary" style={{ fontSize: 12 }}>
            Created {createdAt}
          </Text>
          {isActive && !isDraft && (
            <div style={{ marginTop: 6 }}>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                <div
                  onClick={(e) => {
                    e.stopPropagation();
                    onSelectAgent(null);
                  }}
                  onMouseEnter={(e) => {
                    if (selectedAgentNodeId) {
                      e.currentTarget.style.backgroundColor = '#fafafa';
                    }
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = selectedAgentNodeId
                      ? '#fff'
                      : '#e6f4ff';
                  }}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: 10,
                    padding: '8px 10px',
                    borderRadius: 10,
                    border: `1px solid ${
                      selectedAgentNodeId ? '#f0f0f0' : '#91caff'
                    }`,
                    backgroundColor: selectedAgentNodeId ? '#fff' : '#e6f4ff',
                    cursor: 'pointer',
                    transition:
                      'background-color 0.15s ease, border-color 0.15s ease',
                  }}>
                  <div style={{ minWidth: 0, flex: 1 }}>
                    <Text strong style={{ display: 'block', fontSize: 13 }}>
                      All agents
                    </Text>
                    <Text
                      type="secondary"
                      style={{
                        fontSize: 12,
                        display: '-webkit-box',
                        WebkitLineClamp: 1,
                        WebkitBoxOrient: 'vertical',
                        overflow: 'hidden',
                      }}>
                      show the full thread
                    </Text>
                    <ThreadTokenUsageLine
                      usage={threadUsage}
                      contextPercent={contextPercent}
                      contextMaxTokens={contextMaxTokens}
                      withPopover
                    />
                  </div>
                </div>

                {agents.length > 0 ? (
                  agents.map((agent) => {
                    const isSelected = selectedAgentNodeId === agent.nodeId;
                    const agentUsage = usageByNode[agent.nodeId];
                    const templateId = getNodeTemplateId(agent.nodeId);
                    const summarizeMaxTokens =
                      templateId === 'simple-agent'
                        ? getNodeConfigNumber(
                            agent.nodeId,
                            'summarizeMaxTokens',
                          )
                        : undefined;
                    return (
                      <div
                        key={agent.nodeId}
                        onClick={(e) => {
                          e.stopPropagation();
                          onSelectAgent(agent.nodeId);
                        }}
                        onMouseEnter={(e) => {
                          if (!isSelected) {
                            e.currentTarget.style.backgroundColor = '#fafafa';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (!isSelected) {
                            e.currentTarget.style.backgroundColor = '#fff';
                          }
                        }}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 10,
                          padding: '8px 10px',
                          borderRadius: 10,
                          border: `1px solid ${
                            isSelected ? '#91caff' : '#f0f0f0'
                          }`,
                          backgroundColor: isSelected ? '#e6f4ff' : '#fff',
                          cursor: 'pointer',
                          transition:
                            'background-color 0.15s ease, border-color 0.15s ease',
                        }}>
                        <Avatar
                          size={28}
                          src={agent.avatarSrc}
                          style={{ background: '#f0f0f0', flexShrink: 0 }}
                        />
                        <div style={{ minWidth: 0, flex: 1 }}>
                          <Text
                            strong
                            style={{
                              display: 'block',
                              fontSize: 13,
                              whiteSpace: 'nowrap',
                              overflow: 'hidden',
                              textOverflow: 'ellipsis',
                            }}>
                            {agent.label}
                          </Text>
                          <Text
                            type="secondary"
                            style={{
                              display: 'block',
                              fontSize: 12,
                              whiteSpace: 'nowrap',
                              overflow: 'hidden',
                              textOverflow: 'ellipsis',
                            }}>
                            {agent.description || ''}
                          </Text>
                          <ThreadTokenUsageLine
                            usage={agentUsage}
                            contextMaxTokens={summarizeMaxTokens}
                            withPopover
                          />
                        </div>
                      </div>
                    );
                  })
                ) : (
                  <Text type="secondary" style={{ fontSize: 12 }}>
                    No agents yet
                  </Text>
                )}
              </div>
            </div>
          )}
        </Space>
      </div>
    );
  },
);

ThreadListItem.displayName = 'ThreadListItem';
