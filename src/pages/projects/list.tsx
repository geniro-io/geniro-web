import {
  DeleteOutlined,
  EditOutlined,
  EllipsisOutlined,
  FolderOpenOutlined,
  MessageOutlined,
  NodeIndexOutlined,
  PlusOutlined,
} from '@ant-design/icons';
import {
  App,
  Button,
  Card,
  ColorPicker,
  Dropdown,
  Empty,
  Form,
  Input,
  Modal,
  Spin,
  Typography,
} from 'antd';
import { formatDistanceToNow } from 'date-fns';
import { useState } from 'react';
import { Navigate, useNavigate } from 'react-router';

import { projectsApi } from '../../api';
import type { CreateProjectDto, ProjectDto } from '../../autogenerated';
import { useProjectContext } from '../../contexts/ProjectContext';
import { extractApiErrorMessage } from '../../utils/errors';

const { Title, Text, Paragraph } = Typography;

interface ProjectFormValues {
  name: string;
  description?: string;
  icon?: string;
}

const DEFAULT_PROJECT_COLORS = [
  '#3B82F6',
  '#10B981',
  '#F59E0B',
  '#EF4444',
  '#8B5CF6',
  '#EC4899',
  '#06B6D4',
  '#84CC16',
];

const ProjectCard = ({
  project,
  onOpen,
  onEdit,
  onDelete,
}: {
  project: ProjectDto;
  onOpen: (id: string) => void;
  onEdit: (project: ProjectDto) => void;
  onDelete: (id: string) => void;
}) => {
  const accentColor = project.color ?? '#3B82F6';

  return (
    <Card
      data-testid="project-card"
      hoverable
      onClick={() => onOpen(project.id)}
      style={{
        borderRadius: 12,
        border: '1px solid #e5e7eb',
        backgroundColor: '#ffffff',
        cursor: 'pointer',
        overflow: 'hidden',
      }}
      styles={{
        body: {
          padding: 16,
          display: 'flex',
          flexDirection: 'column',
          height: '100%',
        },
      }}>
      {/* Top: icon + name + menu */}
      <div
        style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'flex-start',
        }}>
        <div
          style={{
            display: 'flex',
            alignItems: 'center',
            gap: 10,
            minWidth: 0,
          }}>
          <div
            style={{
              width: 36,
              height: 36,
              borderRadius: 8,
              backgroundColor: `${accentColor}20`,
              border: `2px solid ${accentColor}`,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: 18,
              flexShrink: 0,
            }}>
            {project.icon ?? (
              <FolderOpenOutlined style={{ color: accentColor }} />
            )}
          </div>
          <Text strong ellipsis style={{ fontSize: 15, color: '#111827' }}>
            {project.name}
          </Text>
        </div>
        <div onClick={(e) => e.stopPropagation()}>
          <Dropdown
            trigger={['click']}
            menu={{
              items: [
                { key: 'edit', icon: <EditOutlined />, label: 'Edit' },
                { type: 'divider' },
                {
                  key: 'delete',
                  icon: <DeleteOutlined />,
                  danger: true,
                  label: 'Delete',
                },
              ],
              onClick: ({ key }) => {
                if (key === 'edit') onEdit(project);
                if (key === 'delete') onDelete(project.id);
              },
            }}>
            <Button
              type="text"
              icon={<EllipsisOutlined />}
              style={{ border: 'none', boxShadow: 'none', color: '#6b7280' }}
            />
          </Dropdown>
        </div>
      </div>

      {/* Middle: description */}
      <div style={{ marginTop: 8 }}>
        {project.description && (
          <Paragraph
            ellipsis={{ rows: 2 }}
            style={{ color: '#6b7280', fontSize: 13, margin: 0 }}>
            {project.description}
          </Paragraph>
        )}
      </div>

      {/* Bottom: stats row */}
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: 16,
          paddingTop: 8,
          borderTop: '1px solid #f3f4f6',
        }}>
        <Text
          type="secondary"
          style={{
            fontSize: 12,
            display: 'flex',
            alignItems: 'center',
            gap: 4,
          }}>
          <NodeIndexOutlined />
          {project.graphCount}
        </Text>
        <Text
          type="secondary"
          style={{
            fontSize: 12,
            display: 'flex',
            alignItems: 'center',
            gap: 4,
          }}>
          <MessageOutlined />
          {project.threadCount}
        </Text>
        <Text type="secondary" style={{ fontSize: 12, marginLeft: 'auto' }}>
          {formatDistanceToNow(new Date(project.updatedAt), {
            addSuffix: true,
          })}
        </Text>
      </div>
    </Card>
  );
};

export const ProjectsListPage = () => {
  const { message } = App.useApp();
  const navigate = useNavigate();
  const { projects, loading, loadProjects } = useProjectContext();
  const [form] = Form.useForm<ProjectFormValues>();
  const [modalOpen, setModalOpen] = useState(false);
  const [editingProject, setEditingProject] = useState<ProjectDto | null>(null);
  const [saving, setSaving] = useState(false);
  const [deletingId, setDeletingId] = useState<string | null>(null);
  const [deleteConfirmId, setDeleteConfirmId] = useState<string | null>(null);
  const [colorValue, setColorValue] = useState<string>('#3B82F6');

  const handleOpenCreate = () => {
    setEditingProject(null);
    setColorValue('#3B82F6');
    form.resetFields();
    setModalOpen(true);
  };

  const handleOpenEdit = (project: ProjectDto) => {
    setEditingProject(project);
    setColorValue(project.color ?? '#3B82F6');
    form.setFieldsValue({
      name: project.name,
      description: project.description ?? '',
      icon: project.icon ?? '',
    });
    setModalOpen(true);
  };

  const handleCloseModal = () => {
    setModalOpen(false);
    setEditingProject(null);
    form.resetFields();
  };

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      setSaving(true);

      const payload: CreateProjectDto = {
        name: values.name.trim(),
        description: values.description?.trim() || null,
        icon: values.icon?.trim() || null,
        color: colorValue || null,
      };

      if (editingProject) {
        await projectsApi.updateProject(editingProject.id, payload);
        message.success('Project updated');
        handleCloseModal();
        await loadProjects();
      } else {
        const res = await projectsApi.createProject(payload);
        message.success('Project created');
        handleCloseModal();
        await loadProjects();
        navigate(`/projects/${res.data.id}/graphs`);
      }
    } catch (err) {
      if (typeof err === 'object' && err !== null && 'errorFields' in err) {
        return;
      }
      message.error(extractApiErrorMessage(err, 'Failed to save project'));
    } finally {
      setSaving(false);
    }
  };

  const handleDeleteConfirm = async () => {
    if (!deleteConfirmId) return;
    setDeletingId(deleteConfirmId);
    try {
      await projectsApi.deleteProject(deleteConfirmId);
      message.success('Project deleted');
      await loadProjects();
    } catch (err) {
      message.error(extractApiErrorMessage(err, 'Failed to delete project'));
    } finally {
      setDeletingId(null);
      setDeleteConfirmId(null);
    }
  };

  const handleOpenProject = (id: string) => {
    navigate(`/projects/${id}/graphs`);
  };

  if (loading) {
    return (
      <div
        style={{
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          height: '50vh',
        }}>
        <Spin size="large" />
      </div>
    );
  }

  if (projects.length === 0) {
    return <Navigate to="/onboarding" replace />;
  }

  return (
    <div style={{ minHeight: '100%' }}>
      <div style={{ background: 'white', padding: 24 }}>
        <div
          style={{
            display: 'flex',
            justifyContent: 'space-between',
            gap: 24,
            flexWrap: 'wrap',
            alignItems: 'center',
          }}>
          <div>
            <Title level={2} style={{ marginBottom: 4 }}>
              Projects
            </Title>
            <Paragraph type="secondary" style={{ marginBottom: 0 }}>
              Organize your agent graphs, knowledge, and repositories by project
            </Paragraph>
          </div>
          <Button
            type="primary"
            icon={<PlusOutlined />}
            size="middle"
            onClick={handleOpenCreate}>
            New Project
          </Button>
        </div>
      </div>

      {projects.length === 0 ? (
        <div style={{ marginTop: 48 }}>
          <Empty
            description="No projects yet"
            image={Empty.PRESENTED_IMAGE_SIMPLE}>
            <Button type="primary" onClick={handleOpenCreate}>
              Create your first project
            </Button>
          </Empty>
        </div>
      ) : (
        <div
          style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))',
            gap: 20,
            padding: 24,
          }}>
          {projects.map((project) => (
            <ProjectCard
              key={project.id}
              project={project}
              onOpen={handleOpenProject}
              onEdit={handleOpenEdit}
              onDelete={setDeleteConfirmId}
            />
          ))}
        </div>
      )}

      <Modal
        title={editingProject ? 'Edit Project' : 'New Project'}
        open={modalOpen}
        onCancel={handleCloseModal}
        onOk={handleSubmit}
        confirmLoading={saving}
        okText="Save"
        destroyOnClose>
        <Form form={form} layout="vertical" style={{ marginTop: 16 }}>
          <Form.Item
            name="name"
            label="Name"
            rules={[{ required: true, message: 'Project name is required' }]}>
            <Input placeholder="My Project" />
          </Form.Item>
          <Form.Item name="description" label="Description">
            <Input.TextArea
              rows={3}
              placeholder="Describe what this project is for"
            />
          </Form.Item>
          <Form.Item
            name="icon"
            label="Icon"
            extra="Emoji or icon slug, e.g. ðŸš€ or robot">
            <Input placeholder="ðŸš€" />
          </Form.Item>
          <Form.Item label="Color" extra="Accent color for this project">
            <ColorPicker
              value={colorValue}
              onChange={(color) => setColorValue(color.toHexString())}
              presets={[
                {
                  label: 'Recommended',
                  colors: DEFAULT_PROJECT_COLORS,
                },
              ]}
              showText
            />
          </Form.Item>
        </Form>
      </Modal>

      <Modal
        title="Delete project"
        open={!!deleteConfirmId}
        onCancel={() => setDeleteConfirmId(null)}
        onOk={handleDeleteConfirm}
        confirmLoading={!!deletingId}
        okText="Delete"
        okButtonProps={{ danger: true }}
        centered>
        {(() => {
          const project = projects.find((p) => p.id === deleteConfirmId);
          return (
            <>
              Are you sure you want to delete &quot;
              {project?.name ?? 'this project'}&quot;? All graphs, knowledge
              documents, and repositories inside it will also be deleted. This
              action cannot be undone.
            </>
          );
        })()}
      </Modal>
    </div>
  );
};
