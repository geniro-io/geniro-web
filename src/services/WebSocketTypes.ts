/**
 * WebSocket Event Types and Interfaces
 * Based on the backend socket.io implementation
 */

import type {
  GraphDtoStatusEnum,
  GraphNodeWithStatusDtoStatusEnum,
  GraphRevisionDto,
  ThreadDto,
  ThreadMessageDto,
} from '../autogenerated';

// Notification scope
export enum NotificationScope {
  Graph = 'graph',
  User = 'user',
}

// Base notification interface
export interface BaseNotification {
  type: string;
  graphId: string;
  ownerId: string;
  nodeId?: string;
  threadId?: string;
  internalThreadId?: string;
  runId?: string;
  scope: NotificationScope[];
}

// Graph schema type
export interface GraphSchemaType {
  nodes: {
    id: string;
    template: string;
    config?: Record<string, unknown>;
  }[];
  edges?: {
    from: string;
    to: string;
    label?: string;
  }[];
}

// Graph execution metadata
export interface GraphExecutionMetadata {
  threadId?: string;
  runId?: string;
  parentThreadId?: string;
}

// Graph update notification
export interface GraphUpdateNotification extends BaseNotification {
  type: 'graph.update';
  data: {
    status: GraphDtoStatusEnum;
    schema?: GraphSchemaType;
  };
}

// Agent message notification
export interface AgentMessageNotification extends BaseNotification {
  type: 'agent.message';
  nodeId: string;
  threadId: string;
  internalThreadId: string;
  runId?: string;
  data: ThreadMessageDto;
}

// Agent state update notification
export interface AgentStateUpdateNotification extends BaseNotification {
  type: 'agent.state.update';
  nodeId: string;
  threadId: string;
  parentThreadId: string;
  runId?: string;
  data: {
    generatedTitle?: string;
    summary?: string;
    done?: boolean;
    needsMoreInfo?: boolean;
    toolUsageGuardActivated?: boolean;
    toolUsageGuardActivatedCount?: number;
    inputTokens?: number;
    cachedInputTokens?: number;
    outputTokens?: number;
    reasoningTokens?: number;
    totalTokens?: number;
    totalPrice?: number;
    currentContext?: number;
  };
}

// Thread create notification
export interface ThreadCreateNotification extends BaseNotification {
  type: 'thread.create';
  nodeId?: string;
  threadId: string;
  internalThreadId: string;
  runId?: string;
  data: ThreadDto;
}

// Thread update notification
export interface ThreadUpdateNotification extends BaseNotification {
  type: 'thread.update';
  nodeId?: string;
  threadId: string;
  internalThreadId: string;
  runId?: string;
  data: ThreadDto;
}

// Thread delete notification
export interface ThreadDeleteNotification extends BaseNotification {
  type: 'thread.delete';
  nodeId?: string;
  threadId: string;
  internalThreadId: string;
  runId?: string;
  data: ThreadDto;
}

// Graph node update notification
export interface GraphNodeUpdateNotification extends BaseNotification {
  type: 'graph.node.update';
  nodeId: string;
  threadId?: string;
  runId?: string;
  data: {
    status: GraphNodeWithStatusDtoStatusEnum;
    error?: string | null;
    metadata?: GraphExecutionMetadata;
    additionalNodeMetadata?: Record<string, unknown>;
  };
}

export type GraphRevisionEventType =
  | 'graph.revision.create'
  | 'graph.revision.applying'
  | 'graph.revision.applied'
  | 'graph.revision.failed'
  | 'graph.revision.progress';

export interface GraphRevisionNotification extends BaseNotification {
  type: GraphRevisionEventType;
  data: GraphRevisionDto;
}

// Graph revision progress notification data
export interface GraphRevisionProgressData {
  revisionId: string;
  graphId: string;
  toVersion: string;
  currentNode: number;
  totalNodes: number;
  nodeId: string;
  phase: 'rebuilding' | 'completed';
}

export interface GraphRevisionProgressNotification extends BaseNotification {
  type: 'graph.revision.progress';
  data: GraphRevisionProgressData;
}

// Runtime status notification
export type RuntimeStatusValue =
  | 'Starting'
  | 'Running'
  | 'Stopping'
  | 'Stopped'
  | 'Failed';

export interface RuntimeStatusNotification extends BaseNotification {
  type: 'runtime.status';
  nodeId: string;
  threadId: string;
  data: {
    runtimeId: string;
    status: RuntimeStatusValue;
    runtimeType: string;
    message?: string;
  };
}

// Server error notification
export interface ServerErrorNotification {
  message: string;
}

// Union type for all notification types
export type SocketNotification =
  | GraphUpdateNotification
  | AgentMessageNotification
  | AgentStateUpdateNotification
  | ThreadCreateNotification
  | ThreadUpdateNotification
  | ThreadDeleteNotification
  | GraphNodeUpdateNotification
  | GraphRevisionNotification
  | GraphRevisionProgressNotification
  | RuntimeStatusNotification;

// Client to Server events payload types
export interface SubscribeGraphPayload {
  graphId: string;
}

export interface UnsubscribeGraphPayload {
  graphId: string;
}
